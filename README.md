# GoldMiner小游戏开发文档 

### 2019.7.26

## 零、项目结构

- Artwork 是我们自己的**原创图片素材**文件夹，使用Krita软件手工绘制而成，包含17张图片素材，并按照要求转为psd格式
- GoldMiner 是本游戏的主体工程文件夹
- subdomain 是微信开放数据域(即排行榜)的工程文件夹

## 一、游戏开发背景

1.游戏选题

本次大作业的题目要求借助微信小游戏平台开发一款手机游戏，由于手机性能，屏幕大小的限制，以及微信小程序平台对项目大小的要求，我们最终选择了开发一款经典的小游戏：“黄金矿工（GoldMiner）”。为了更好地展现我们对游戏的设计，更加灵活地拓展功能，我们选择了自己手绘游戏图片资源，因此最终开发了“手绘版黄金矿工”这款小游戏。



2.任务合作完成情况

王世杰：游戏主UI与主逻辑功能设计与实现，游戏内所有动画效果实现，微信开放数据域排行榜，游戏菜单界面设计，游戏设置界面，音效实现，商店功能，游戏关卡设计

吴海隽：美工设计绘图资源，新手指引界面实现，游戏关卡设计



3.游戏介绍

**Gold Miner** 是一款休闲游戏，其核心玩法是玩家扮演一名矿工，点击屏幕中间位置可以放下摇摆的钩子，用于勾取地下的各种资源，如不同大小的黄金与石块，会移动的猪，价值极高的钻石，背着钻石的猪，TNT炸药以及神秘宝藏等，不同的资源具有不同的价值与效果，在每回合的30s倒计时内完成目标钱数的收集即可通关。为了增加游戏性，游戏还设置了商店功能，商店内物品的种类和价格是随机的，具有大力水、炸药、钻石书、幸运草等效果各异的道具。

游戏主界面如下：

![level2](http://ww4.sinaimg.cn/large/006tNc79ly1g5dd228ahnj31s60u0grv.jpg)



4.说明

我们的创意主要来自于经典小游戏黄金矿工，但我们的所有工作，包括素材绘制，游戏规则设定，道具实现，动画实现等都由自主完成，并未参考他人工作。



5.开发环境

- IDE：Cocos Creator 2.0.10
- 编程语言：JavaScript (ES6)
- 操作系统：macOS 10.14 和 Windows 10 Pro Education
- 上传工具：微信开发者工具 Stable v1.02.1907160



## 二、游戏策划与功能

1. 游戏概要

   - **名称**：手绘版黄金矿工

   - **概述**：《手绘版黄金矿工》是一款老少皆宜的休闲游戏，游戏的目标很简单：玩家扮演一名黄金矿工，在合适的时机放下钩子勾取底下的物品，不同的物品具有不同的价值和特殊属性，最终在时长30s的一回合内达到目标资金即可过关，而金钱在不同关卡之间是累计的，玩家也可使用累积的金钱在每回合结束后的商店中购买道具以获取不同加成。

   - **特色**：本款游戏最大的特色就是我们使用的原创手绘素材，采用黑底白色线条的简约设计，手绘风格的界面更加随性与具有趣味性。而游戏中出现的不同的道具与物品也大大丰富了游戏内容。在关卡设定方面，我们一共提供了8个关卡，难度逐渐提升，其中有些特色关卡非常考验玩家的专注度与准确性，例如第七关，通过TNT与宝物的绑定提升难度，玩家稍有不慎就会触发炸弹炸掉宝物，从而导致任务失败。

     

2. 界面场景设定

此部分请直接查看文档第三部分——界面布局设计



3. 游戏元素

   游戏中具有以下几种可以交互的实体元素：

   主游戏内元素：

   1. 钩子：玩家的工具，用于勾住宝物。
   2. 金块：地下宝物之一，具有大中小三个尺寸，价值与拉取速度不同。
   3. 石头：地下主要障碍物之一，具有大中小三个尺寸，重量较大，价值较低
   4. 小猪：地下主要障碍物之一，会在地下水平运动以干扰玩家，价值极低
   5. 钻石：地下宝物之一，尺寸很小，重量很轻，价值极高
   6. 钻石猪：会运动的猪背着钻石，价格为猪与钻石的和
   7. 宝物袋：地下宝物之一，随机获取金钱或道具，重量随机
   8. 宝物盒：地下宝物之一，随机获取金钱或道具，重量随机，通常比宝物袋更好
   9. 鞭炮：可拾取道具，拾取后自己的鞭炮道具数目+1
   10. TNT炸药桶：不可拾取，一旦触碰会发生爆炸，使得周边物品消失

   ![WechatIMG11](http://ww4.sinaimg.cn/large/006tNc79ly1g5debviekdj31s60u0qaz.jpg)

   商店道具：

   1. 石头书：商店道具，价格随机，购买后可在下一回合内增加石头的价值
   2. 大力水：商店道具，价格随机，购买后在下一回合中可以以很快速度勾取任何物品，也可在宝箱中获取
   3. 鞭炮：商店道具，价格随机，在回合间累积，可以用来炸掉勾取物品，例如石块等，可以在地下拾取，也可在宝箱宝物袋中获取
   4. 幸运草：商店道具，价格随机，购买后可在下一回合内提升幸运度，在宝箱与宝物袋子中获取更好的物品与道具
   5. 优质钻石：商店道具，价格随机，购买后在下一回合内提高钻石价值

   ![WechatIMG10](http://ww4.sinaimg.cn/large/006tNc79ly1g5debb26ubj31s60u0gvr.jpg)

   

4. 关卡设定

游戏具有精心设计的八个关卡，难度逐渐递增，其中有些特色关卡非常考验玩家的专注度与准确性，例如第七关，通过TNT与宝物的绑定提升难度，玩家稍有不慎就会触发炸弹炸掉宝物，从而导致任务失败。同时由于游戏的随机商店机制，如何合理分配资金购买道具获取加成也为游戏的提供了多样的玩法。



## 三、界面布局和设计

为了契合游戏整体的黑白手绘简约风，我们的布局也力求简练友好，具有趣味性。

下面介绍几个用户界面的布局设计：

+ 主菜单界面

主菜单界面如下图所示：为了提高趣味性，让主题界面不过与单调，我们采用了和主游戏相同的交互方法：点击屏幕方法钩子勾取不同选项，同时这样的设计也能够让新用户第一时间了解游戏的主要交互方式，起到了教学的作用，一举两特，颇具特色。

在授权登录后，右上角会显示用户微信头像。

主菜单界面具有四个选项卡，分别对应教程，开始，排行榜与设置界面，选取拖动后即可进入。

![WechatIMG12](http://ww3.sinaimg.cn/large/006tNc79ly1g5degobtr2j31s60u0n0q.jpg)



+ 教程界面（TUTORIAL）

静态的新手教程页面，介绍了游戏的主要交互方式，道具与商店系统，图片与文字相结合，简单易懂。界面如下图所示：

![131564135971_.pic_hd](http://ww1.sinaimg.cn/large/006tNc79ly1g5demz1v6zj31s60u0gvr.jpg)



![141564135972_.pic_hd](http://ww1.sinaimg.cn/large/006tNc79ly1g5den6e9x8j31s60u0qaz.jpg)



+ 排行榜界面（RANK）

排行榜界面使用微信开放数据域，可以读取好友中该游戏的TOP5排名， 点击右下可返回主菜单

![151564136285_.pic_hd](http://ww1.sinaimg.cn/large/006tNc79ly1g5desma4alj31s60u041l.jpg)



+ 设置界面

可以设置是否静音，点击右下角可返回主菜单

![161564136379_.pic_hd](http://ww4.sinaimg.cn/large/006tNc79ly1g5deu3mnzij31s60u03zj.jpg)



+ 主游戏

  主游戏界面又分为几个界面，下面逐个展开介绍：

  + 关卡载入界面：显示当前关卡和目标，并显示玩家当前具有道具数目，在3s后自动进入游戏界面

    ![181564136500_.pic_hd](http://ww3.sinaimg.cn/large/006tNc79ly1g5dew2nbknj31s60u0q5o.jpg)

  + 主游戏关卡界面：主要游戏界面，右上角显示游戏当前关卡和目标数，上方显示倒计时数目，小人左面又鞭炮计数器和闪电形状的力量表示，用以提醒玩家，点击鞭炮即可炸掉当前物品。左边为当前收集钱数。“EXIT”按钮可以点击后放弃当前游戏返回主菜单，其中鞭炮数目和钱数增加都有动画效果以提示状态改变。

    ![171564136500_.pic_hd](http://ww4.sinaimg.cn/large/006tNc79ly1g5dez1016jj31s60u0441.jpg)

  + 关卡结束界面，有失败，成功，通关三种状态，可以展示分数，可以实现重新游戏，返回主菜单等操作。

  + 商店界面：在商店内显示物品的价格，而是否售光也是随机的。玩家可以点击图标购买，购买后该物品会消失，同时左下角会根据购买状态提醒玩家，如“已售光”、“钱不够”或“获得一本石头书”等

    ![191564137030_.pic_hd](http://ww2.sinaimg.cn/large/006tNc79ly1g5df57hav9j31s60u00wj.jpg)



## 四、技术实现方案及重点与难点

1. 场景切换时信息的保留与传递

Cocos Creator中最基本的可视载体是场景文件（scene），而scene之间的数据不能相互访问，因此为了场景切换之间的信息传递是一个重要的问题。

在本游戏中，我采用了全局变量的方法来实现，即定义脚本` Global.js`，记录一些游戏中需要跨场景的全局信息，以及一些游戏参数设定，例如当前金币数，当前鞭炮数，各个关卡的目标钱数，这样通过对全局变量的访问与修改，即可实现不同场景之间的信息传递与交流。



2. 游戏内动画的实现

本实验中，设计自然，生动的游戏动画效果占据了很大一部分的工作量，经过统计，在本实验中我一共定义了20个anim动画脚本。其中根据功能主要分为以下几种：

+ 小猪的跑动动画，根据方向和种类一共4种，采用`spriteFrame`属性循环切换来实现双腿跑动的效果

+ 钩子的转动动画，根据转动起点不同一共分为3种，设置角度属性

+ 载入动画，共1个，通过循环切换标签文本实现载入效果

+ 爆炸动画，共10个，其中以最复杂的TNT爆炸效果为例：为了生成逼真的爆炸动画，我对爆炸的过程进行了分析：发生爆炸时，桶状物体首先变成蘑菇云，随后一段时间内蘑菇云体积变大，最后蘑菇云透明度逐渐降低至0淡出。在透明度为0的那一帧，我调用了回调函数`onBombOver`，用于判断TNT周围物品并destory相关节点，完成爆炸——消失的全过程。最后封装成一个动画，配合音效即可实现较为逼真的爆炸效果。

![image-20190726190646244](http://ww1.sinaimg.cn/large/006tNc79ly1g5dg6uml0yj312i0f6ta3.jpg)

+ 金钱/鞭炮获取提示动画，共2个，该动画效果是当获取金钱或者鞭炮时，在计数器旁显示“+xx”字样并淡出以提示玩家。



3. 排行榜——微信接口的调用

> 微信小游戏为了保护其社交关系链数据，增加了子域的概念，子域又叫**开放数据域**，是一个单独的游戏执行环境。子域中的资源、引擎、程序，都和主游戏完全隔离……由于子域只能在离屏画布 sharedCanvas 上渲染，因此需要我们把 sharedCanvas 绘制到主域上。
> ——Cocos Creator文档《接入微信小游戏的子域》

为了增强游戏的社交趣味性，我们选择加入无尽模式下分数的排行榜。正如文档里所说，子域中的资源、引擎、程序，都和主游戏完全隔离，在Cocos Creator中简单来说，排行榜和我们的游戏就是两个项目。经过尝试，我们发现直接在排行榜项目中添加按钮是没有作用的，因为子域只能在离屏画布上渲染，并把这个离屏画布上的内容“画到”到主域的某节点上，子域中的按钮在主域中只是一个图像而已，并无法相应点击事件。不仅如此，主域和子域之间的信息传递是单向的：只能主域向子域发送消息。所以在主域无法保存排行榜状态。
于是我们选择在唤出排行榜的时候，设置一个1000 ms的计时器，当时间到了之后将按钮显示出来，营造一种排行榜上的按键和排行榜一起经过加载出现在屏幕上。点击按键会由主域向子域发送消息，子域会监听这些消息并作出相应的响应操作。

4. 游戏场景的总控制

游戏场景下，给根节点绑定名为Game.js的组件，用以控制整个游戏的流程，其属性中包含了所有游戏过程中元素的引用，例如用户控制圆圈circle节点，障碍物obstacles节点，以及一些游戏的提示文字。游戏中有一些确定的数字量，如障碍物之间的单位距离，两个圆块之间的直径距离，统一放在了gamePreSet.js文件中，并且在controller节点加载时包含进来，这样对游戏中一些通用的量可以有比较好的管理。游戏中除了这一点就是游戏状态的更新，游戏中共定义了以下几种状态：

- on——游戏正常进行
- deadPause——玩家死亡之后的一瞬间需要暂停一会儿
- passPause——玩家成功过关之后同样有一段时间暂停
- rewind——玩家死亡之后需要退回到开始的状态，两个圆块也要回到角度为0的状态，此状态即完成这一动作
- revolve——玩家成功通过这一关，也要回到开始的状态，这一状态完成此动作

游戏中根据这些状态的分配以及绑定的一些事件即可以完成对游戏流程的总控制。在start函数中，绑定了一些事件的处理函数，包括加载下一关，撞击后死亡，撞击复活动作完成，开始下一关等。
除此之外，圆形块和障碍物也分别有自己的状态，通过状态决定他们的动作，但状态的更改都是由游戏总控制来更改。

5. 障碍物的动作实现

由于游戏中有几种比较复杂的障碍物动作，他们的实现方式都是通过组件的形式，首先所有的障碍物都是白色矩形，通过Rect这一个prefab来实现动态添加删除的功能。而不同的动作则是由组件来完成，需要一个动作时只需要挂载一个已经实现的组件并提供参数，即可实现动作。这样的好处在于可以将多个动作同时组合，使得一个障碍能做出多个动作。
在说明各个动作的实现之前，先解释一下障碍物整体是如何实现的，在obstacles.js文件中实现了这些，所有障碍物都挂在一个总障碍的节点下，这样在这个节点中绘制所有的障碍，直接移动这个节点，就能做到让所有障碍以某一速度一起移动。这样完全不会影响各个障碍之间的独立性，如果没有特殊动作，一个障碍被生成之后其实不需要多挂载任何组件。所以这个文件中需要实现的最核心功能即为**绘制**一个关卡，此函数根据一个输入的数组，将需要绘制的关卡绘制到obstacles节点中，作为其子节点，再根据提供的动画效果，加入动画组件。更新函数中，根据目前的游戏状态更新显示即可。（rewind状态下所有的动作都不是瞬间回去的，所以需要一个加速回到初始状态的过程，这一点在很多地方都有体现）
接下来介绍几个特殊动作：

- moveDown动作：障碍物在距离两个圆块一定距离时加速向下运动，只运动一个spacing的距离（一个spacing即为中心圆的直径，同时也是两个障碍物之前的单位距离）。接受两个参数，分别是开始运动的距离和运动速度的加成，moveDown这一动作的速度直接加给障碍，由于全部障碍还有一个向下运动的速度，故如果速度加成为0.5，障碍将以1.5倍于正常速度的速度移动。实现比较简单，在update中判断状态以及距离即可。
- moveLR动画：障碍物在运行到两个圆块之前先做一个左右的来回移动，包括运行之后也继续做这一动作。接受一个参数：左右运动速度和障碍物下移速度的比例。以障碍物初始时在左边为例，左右运动过程为：向右->向左->玩家做出动作通过这一障碍->向右->向左。实现同样不难，首先通过速度比例计算开始运动的距离（这一距离在moveDown动作中由参数给出，这里不能给出的原因在于一个来回运动是固定的），然后判断状态、距离，计算相应方向并运动即可。
- disappear动画：障碍物在距离两个圆块一定距离时开始消失，这一距离由参数给出，而消失的速度只和障碍物整体的速度有关。我们的默认设定是游戏速度100%时，每一帧其不透明度下降4，这一个值定义在gamePreSet.js文件中。实现同样，判断距离状态即可。
- 旋转动画：旋转动画的更新非常简单，更新节点的rotation值即可，但复杂的地方在于开始距离的计算和旋转角速度。经过测试，对于较短的中间旋转的块，其转速应该和用户控制两个圆块转动角速度一致（实际略小一些），在边上的较长的块，转速为用户控制物体转动角速度的1/3。然后再经过一些计算可得开始旋转的距离，在更新函数中判断距离旋转即可。

注：这些动作都包含了在rewind状态下，加速回到初始状态的动作，方式基本和正常进行一样，不过要多加一个加速倍数，此倍数由撞击时在obstacles.js文件中计算，由于rewind时间是确定的，故根据玩家已经走过路程不同，其速度会不同。

6. 游戏动画效果——两个圆球拖尾的实现

游戏中为了实现两个圆块的看起来向前运动的特效，以及旋转时的影子的效果，需要两个圆块后面的拖尾，我们首先看了cocos creator提供的拖尾效果，发现无法满足我们的要求，于是决定采用粒子效果，初始时定义其角度为-90，这样就可以发射到“后方”去，使用粒子特效可以得到我们需要的效果，同时在撞击死亡的瞬间，需要有一个撞击的效果，于是直接在代码中更改粒子效果，然后再结束后更改回来，即实现了撞击后爆炸的效果。

7. 关卡的生成和加载

### 关卡生成

关卡的定义全都在level.js这个文件中，每一个关卡都包含了一个障碍物数组，对于每一个对象，其定义了类别，对其，和上一个障碍之间的距离这几个变量，另外如果想要添加动作，直接添加动作的变量即可。对于关卡的生成，我们自己制作了43个不同的关卡，同时构建了一个关卡编辑器，可以较快的生成关卡并导出js代码。无尽模式的生成中，首先确定了几十种不同的障碍物组合方式，但这些方式中都不包含任何消失动画，除此之外其他动画和障碍都有，然后在随机地选取5～7种障碍物的模式，然后即可生成。对于消失动画，任何一个障碍都有50%的概率有消失动画，而消失动画也有不同的开始距离，这样可以保证生成的无尽模式关卡种类相当多，几乎不可能出现两个完全一致的。

### 关卡加载

关卡加载是obstacles.js文件的主体功能，通过输入的关卡障碍数组，开始在obstacles节点中添加子节点，需要通过种类决定其大小，通过对齐方式决定其x坐标，通过和上一个障碍的距离决定其y坐标，通过给定的动画添加动画组件。这样就能绘制一个关卡。

8. 碰撞的处理

cocos creator中已经给出了碰撞组件，直接挂载到两个圆块的节点上即可，而对于事件的处理，在Dot.js中，其作为圆块的组件，将撞击事件直接向上传播，直到Game.js中处理这个事件即可，当然撞击只有在游戏状态为进行时有反应。

9. 两个圆块的动作

圆块的动作相对比较简单，用户控制方面直接使用cocos creator的API即可。更新其位置同样比较简单，按下时更改角度即可。较难点在于用户死亡或者通关之后，两个圆块要逐渐运动到初始位置，即在rewind和revolve状态下，圆块的动作。为此，在Game.js中计算需要旋转的角度，然后在circle.js（两个圆块父节点所挂载的组件）中，根据目前状态更新，就可以实现这一动作。

## 五、游戏测试

我们两个人的手机型号分别是锤子坚果 Pro 2和荣耀 10，运行体验版的小游戏，除了排行榜唤出时获取微信云端数据时出现延迟外，其他交互无明显延迟。关卡之中的操作也十分顺滑流畅。我们在游戏开发时邀请一些同学、朋友做我们游戏的体验者，下面是一些测试感受：

| **名字** |  **手机型号**  |               **测试感受**               |
| :------: | :------------: | :--------------------------------------: |
|  Z同学   |  Vivo xplay5   |         “不卡顿，游戏体验可以的”         |
|  W同学   |    Vivo x7     |       “游戏体验流畅、关卡有些简单”       |
|  Z同学   |   iPhone 6s    |    “元素挺丰富，节奏很好，像原作一样”    |
|  M同学   |    iPhone 7    |        “关卡好难，其他都不错呀~”         |
|  H同学   |    iPhone 7    |       “很流畅，玩到停不下来(真的 ”       |
|  W同学   |   iPhone 6s    |              “游戏挺好的啊”              |
|  王述熠  |    荣耀 10     | “很好玩，加上动感的音乐和音效之后更是！” |
|   纳鑫   | 锤子坚果 Pro 2 |           “我也玩到停不下来！”           |

## 六、游戏亮点

本游戏的亮点主要在于比较困难的关卡，根据不少同学的反馈，游戏的难度较高，不过我们认为这是一件好事。
另外，游戏操作简单，容易上手，关卡的节奏性很强，考验玩家的反应和节奏把握能力，也会受玩家的喜爱。游戏中关卡多变，障碍的种类很多，有各种各样的动画和组合，可以很好的吸引玩家。三种不同的游戏模式和我们制作的43个不同的关卡都很有吸引力，能够很好地把握节奏通过难度较高的一小关可以给玩家带来成就感。

